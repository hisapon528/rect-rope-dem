<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é•·æ–¹å½¢ã®é¢ç© å¯è¦–åŒ–ï¼ˆãƒ­ãƒ¼ãƒ—æ  / ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆï¼‰</title>
<style>
  :root{ --gap:24px; --ui:14px; --header-h:56px; }
  html,body{height:100%; margin:0}
  body{
    display:grid; grid-template-rows: var(--header-h) 1fr;
    height:100dvh; overflow:hidden; background:#fafafa;
    font:var(--ui)/1.4 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif; color:#333;
  }
  header{display:flex; align-items:center; gap:48px; padding:10px 16px; border-bottom:1px solid #e6e6e6; background:#fff;}
  header .grp{display:flex; align-items:center; gap:8px}
  input[type="number"]{width:84px; padding:6px 8px; border:1px solid #cfcfcf; border-radius:8px}
  input[type="range"]{width:160px}
  button{appearance:none; border:1px solid #cfcfcf; border-radius:8px; background:#fff; padding:6px 10px; cursor:pointer}
  main{min-height:0; display:grid; grid-template-columns:minmax(320px,1fr) minmax(320px,1fr); gap:var(--gap); padding:var(--gap); box-sizing:border-box; overflow:hidden;}
  canvas{display:block; width:100%; height:100%; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 1px 0 rgba(0,0,0,.03) inset;}

  /* ç”»é¢ãŒåºƒã™ãã‚‹æ™‚ã«å·¨å¤§åŒ–ã—éããªã„ãŸã‚ã®ä¸Šé™ï¼ˆä»»æ„ï¼‰ */
  main{ max-width: 1400px; margin-inline:auto; }

  /* ã‚¹ã‚¿ãƒ¼ãƒˆå…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  #startFS{
    position:fixed; inset:0; display:grid; place-items:center;
    background:rgba(0,0,0,.5); color:#fff; z-index:1000;
  }
  #startFS.is-hidden{ display:none !important; }
  #startFS .panel{
    position:relative;
    background:#111; padding:28px 32px; border-radius:16px; text-align:center;
    max-width:min(92vw,560px);
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  #startFS h1{margin:0 0 10px; font-size:22px}
  #startFS p{margin:0 0 18px; opacity:.9}
  #startBtn{
    font-size:16px; padding:10px 18px; border-radius:10px;
    border:1px solid #3aa36e; background:#38c172; color:#fff; cursor:pointer;
  }
  /* å³ä¸Š Ã— ãƒœã‚¿ãƒ³ */
  #startClose{
    position:absolute; top:8px; right:8px;
    width:32px; height:32px; border-radius:8px;
    border:1px solid #444; background:#222; color:#fff; cursor:pointer;
    font-size:18px; line-height:30px; padding:0;
  }
  #startClose:hover{ background:#2a2a2a; }

  /* çµ‚äº†ãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šå›ºå®šï¼‰ */
  #quitBtn{
    position:fixed; top:10px; right:10px; z-index:900;
    padding:8px 12px; border-radius:10px; border:1px solid #d66; background:#f66; color:#fff; font-weight:600; cursor:pointer;
  }
  #quitBtn:disabled{opacity:.5; cursor:default}
</style>
</head>
<body>
  <!-- èµ·å‹•æ™‚ã«æŠ¼ã—ã¦ã‚‚ã‚‰ã†å…¨ç”»é¢ãƒœã‚¿ãƒ³ï¼ˆÃ—ã§é–‰ã˜ã‚‹ã¨é€šå¸¸è¡¨ç¤ºã®ã¾ã¾é€²è¡Œï¼‰ -->
  <div id="startFS" aria-hidden="false">
    <div class="panel">
      <button id="startClose" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      <h1>å…¨ç”»é¢ã§é–‹å§‹</h1>
      <p>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å…¨ç”»é¢è¡¨ç¤ºã«ãªã‚Šã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ä»•æ§˜ã§è‡ªå‹•ã§ã¯åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã›ã‚“ï¼‰ã€‚</p>
      <button id="startBtn">å…¨ç”»é¢ã§é–‹å§‹ã™ã‚‹</button>
      <p style="margin-top:10px; font-size:12px; opacity:.8;">â€» ã†ã¾ãå…¥ã‚‰ãªã„å ´åˆã¯ F11ï¼ˆMacã¯ âŒƒâŒ˜Fï¼‰ã§ã‚‚å…¨ç”»é¢ã«ã§ãã¾ã™ã€‚</p>
    </div>
  </div>

  <!-- å³ä¸Šã€Œçµ‚äº†ã€ -->
  <button id="quitBtn" title="çµ‚äº†">çµ‚äº†</button>

  <header>
    <div class="grp">
      <label id="labA" for="aIn">ğ‘:</label>
      <input id="aIn" type="number" step="0.1" min="0.1" value="8">
    </div>
    <div class="grp">
      <label id="labX" for="xRange">ğ‘¥:</label>
      <input id="xRange" type="range" min="0" max="1000" value="500">
      <input id="xIn" type="number" step="0.1" min="0" value="4">
    </div>
    <button id="traceBtn">è»Œè·¡ã‚’è¡¨ç¤º</button>
  </header>

  <main>
    <canvas id="geom"></canvas>
    <canvas id="graph"></canvas>
  </main>

<script>
/* ========= ã“ã“ã‚ˆã‚Šä¸‹ã¯ã‚¢ãƒ—ãƒªæœ¬ä½“ ========= */

/* çŠ¶æ…‹/UI */
const state = { a:8, x:4, showTrace:false, trace:[] };
const aIn=document.querySelector('#aIn');
const xRange=document.querySelector('#xRange');
const xIn=document.querySelector('#xIn');
const traceBtn=document.querySelector('#traceBtn');
const cvsGeom=document.querySelector('#geom');
const cvsGraph=document.querySelector('#graph');
const quitBtn=document.querySelector('#quitBtn');
const startFS=document.getElementById('startFS');
const startBtn=document.getElementById('startBtn');
const startClose=document.getElementById('startClose');
const DPR = Math.max(1, window.devicePixelRatio||1);

/* å¹¾ä½•ãƒ‘ãƒãƒ«ã ã‘æ–‡å­—2å€ */
const GEO_FONT_PX = 28;
const GEO_LINE_H  = Math.round(GEO_FONT_PX*1.25);

/* -------- ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åˆ¶å¾¡ & çµ‚äº† -------- */
function showStartOverlay(){
  startFS?.classList.remove('is-hidden');
  startFS?.setAttribute('aria-hidden','false');
  if (startFS) startFS.style.display = 'grid';
}
function hideStartOverlay(){
  startFS?.classList.add('is-hidden');
  startFS?.setAttribute('aria-hidden','true');
  if (startFS) startFS.style.display = 'none';
}
async function enterFullscreen(){
  try{
    const target = document.documentElement || document.body;
    if (target.requestFullscreen)      await target.requestFullscreen();
    else if (target.webkitRequestFullscreen) target.webkitRequestFullscreen();
    if (screen.orientation?.lock) screen.orientation.lock('landscape').catch(()=>{});
  }catch(e){
    /* å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ */
  }finally{
    hideStartOverlay(); // â†æˆå¦ã«é–¢ã‚ã‚‰ãšé–‰ã˜ã‚‹
  }
}
async function exitFullscreen(){
  if (document.fullscreenElement){
    try{ await document.exitFullscreen(); }catch(e){}
  }
}
async function quitApp(){
  quitBtn.disabled = true;
  await exitFullscreen();
  try{ window.close(); }catch(e){}
  try{ const w = window.open('','_self'); w.close(); }catch(e){}
  setTimeout(()=>{ 
    alert('ã“ã®ã‚¿ãƒ–ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ä»•æ§˜ã§è‡ªå‹•ã§ã¯é–‰ã˜ã‚‰ã‚Œã¾ã›ã‚“ã€‚\nã‚¿ãƒ–ã® Ã— ã‚’æŠ¼ã™ã‹ã€Ctrl+W / âŒ˜W ã§é–‰ã˜ã¦ãã ã•ã„ã€‚');
    quitBtn.disabled = false;
  }, 300);
}
quitBtn.addEventListener('click', quitApp);
startBtn?.addEventListener('click', enterFullscreen);
startClose?.addEventListener('click', hideStartOverlay);
document.addEventListener('DOMContentLoaded', showStartOverlay);

/* -------- å…¥åŠ›åŒæœŸ -------- */
function applyA(){
  const a = Math.max(0.1, parseFloat(aIn.value)||8);
  const ratio = state.a>0 ? state.x/state.a : 0;
  state.a = a;
  state.x = Math.min(a, Math.max(0, ratio*a));
  xIn.max = a;
  xIn.value = state.x.toFixed(3);
  xRange.value = Math.round((state.x/state.a)*1000);
  if (state.showTrace) state.trace = [];
  drawAll();
}
function applyXFromRange(){
  state.x = (parseInt(xRange.value)/1000)*state.a;
  xIn.value = state.x.toFixed(3);
  if (state.showTrace) pushTrace();
  drawAll();
}
function applyXFromInput(){
  const x = Math.max(0, Math.min(state.a, parseFloat(xIn.value)||0));
  state.x = x;
  xRange.value = Math.round((state.x/state.a)*1000);
  if (state.showTrace) pushTrace();
  drawAll();
}
aIn.addEventListener('input', applyA);
xRange.addEventListener('input', applyXFromRange);
xIn.addEventListener('input', applyXFromInput);
traceBtn.addEventListener('click', ()=>{
  state.showTrace = !state.showTrace;
  traceBtn.textContent = state.showTrace ? 'è»Œè·¡ã‚’éè¡¨ç¤º' : 'è»Œè·¡ã‚’è¡¨ç¤º';
  state.trace = [];
  if (state.showTrace) pushTrace();
  drawAll();
});
function pushTrace(){
  const y = state.x*(state.a-state.x);
  const last = state.trace[state.trace.length-1];
  if (!last || Math.hypot(last[0]-state.x,last[1]-y)>1e-6){
    state.trace.push([state.x,y]);
    if (state.trace.length>20000) state.trace.shift();
  }
}

/* -------- ã‚­ãƒ£ãƒ³ãƒã‚¹æ•´å½¢ -------- */
function fitCanvas(cvs){
  const r = cvs.getBoundingClientRect();
  const w = Math.max(1, Math.floor(r.width*DPR));
  const h = Math.max(1, Math.floor(r.height*DPR));
  if (cvs.width!==w || cvs.height!==h){ cvs.width=w; cvs.height=h; }
  const ctx = cvs.getContext('2d');
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.imageSmoothingEnabled = true;
  return ctx;
}
CanvasRenderingContext2D.prototype.roundRect ??= function(x,y,w,h,r){
  r=Math.max(0,Math.min(r,Math.min(w,h)/2));
  this.beginPath();
  this.moveTo(x+r,y);
  this.arcTo(x+w,y,  x+w,y+h, r);
  this.arcTo(x+w,y+h,x,  y+h, r);
  this.arcTo(x,  y+h,x,  y,   r);
  this.arcTo(x,  y,  x+w,y,   r);
  this.closePath();
}

/* -------- ãƒ­ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ«ï¼ˆè–„èŒ¶ãƒ™ãƒ¼ã‚¹ / é»’ç¸ï¼‰ -------- */
function makeRopeTile(thickness){
  const h = Math.max(8, Math.round(thickness));
  const w = Math.max(96, Math.round(h*6));
  const c = document.createElement('canvas'); c.width=w; c.height=h;
  const g = c.getContext('2d');

  g.fillStyle='#d8c090'; g.fillRect(0,0,w,h);           // è–„èŒ¶
  const grd = g.createLinearGradient(0,0,0,h);          // å††ç­’é™°å½±
  grd.addColorStop(0,'rgba(0,0,0,0.18)');
  grd.addColorStop(0.5,'rgba(0,0,0,0.00)');
  grd.addColorStop(1,'rgba(0,0,0,0.22)');
  g.fillStyle=grd; g.fillRect(0,0,w,h);

  const targetPeriod = Math.max(6, Math.round(h*0.40));
  let N = Math.max(20, Math.floor(w/targetPeriod));
  if (N%2===1) N++;
  const period = Math.max(4, Math.floor(w/N));
  const stripeW = Math.max(2, Math.floor(period/2));

  // -45Â°
  g.save(); g.translate(w/2,h/2); g.rotate(-Math.PI/4); g.translate(-w/2,-h/2);
  g.globalAlpha = 0.80; g.fillStyle='#000';
  for(let i=-N;i<2*N;i++){ g.fillRect(i*period, -w, stripeW, 2*w); }
  g.globalAlpha = 0.60;
  for(let i=-N;i<2*N;i++){ g.fillRect(i*period+stripeW, -w, stripeW, 2*w); }
  g.restore();

  // +45Â°
  g.save(); g.translate(w/2,h/2); g.rotate(+Math.PI/4); g.translate(-w/2,-h/2);
  g.globalAlpha = 0.28; g.fillStyle='#000';
  for(let i=-N;i<2*N;i++){ g.fillRect(i*period, -w, stripeW, 2*w); }
  g.globalAlpha = 0.20;
  for(let i=-N;i<2*N;i++){ g.fillRect(i*period+stripeW, -w, stripeW, 2*w); }
  g.restore();

  const img = g.getImageData(0,0,w,h);                  // å¾®å°ãƒã‚¤ã‚º
  const dt = img.data;
  for(let i=0;i<dt.length;i+=4){
    const n=(Math.random()-0.5)*12;
    dt[i]+=n; dt[i+1]+=n; dt[i+2]+=n;
  }
  g.putImageData(img,0,0);

  return {image:c,w,h};
}

/* -------- ãƒ­ãƒ¼ãƒ—æç”»ï¼ˆä½ç›¸ç¶™æ‰¿ï¼‹ãƒªãƒ³ã‚°clipï¼‹é»’è¼ªéƒ­ï¼‰ -------- */
function drawRoundRectPath(ctx,x,y,w,h,r){
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y, x+w,y+h, r);
  ctx.arcTo(x+w,y+h, x,y+h, r);
  ctx.arcTo(x,  y+h, x,y,   r);
  ctx.arcTo(x,  y,   x+w,y, r);
  ctx.closePath();
}
function drawRopeEdge(ctx,tile,x1,y1,x2,y2,phase){
  const dx=x2-x1, dy=y2-y1, len=Math.hypot(dx,dy);
  if (len<0.5) return phase;
  const ang=Math.atan2(dy,dx);
  ctx.save();
  ctx.translate(x1,y1); ctx.rotate(ang);
  const pat=ctx.createPattern(tile.image,'repeat');
  if (pat && pat.setTransform){
    pat.setTransform(new DOMMatrix().translate(-phase,-tile.h/2));
  }else{
    ctx.translate(-phase,0);
  }
  ctx.fillStyle=pat;
  ctx.fillRect(0,-tile.h/2, len, tile.h);
  ctx.restore();
  return (phase+len)%tile.w;
}
function drawRopeArc(ctx,tile,cx,cy,r,a0,a1,phase){
  const L=r*Math.abs(a1-a0), step=Math.max(3,Math.ceil(L/6));
  let px=cx+r*Math.cos(a0), py=cy+r*Math.sin(a0);
  for(let i=1;i<=step;i++){
    const t=i/step, a=a0+(a1-a0)*t;
    const x=cx+r*Math.cos(a), y=cy+r*Math.sin(a);
    phase = drawRopeEdge(ctx,tile,px,py,x,y,phase);
    px=x; py=y;
  }
  return phase;
}
function drawRopeRect(ctx,x,y,w,h,th){
  const tile = makeRopeTile(th);
  let r = Math.min(Math.min(w,h)/2-1, th*3.5);
  r = Math.max(0, r);

  ctx.save();
  ctx.beginPath();
  drawRoundRectPath(ctx, x-th/2, y-th/2, w+th, h+th, r+th/2);
  drawRoundRectPath(ctx, x+th/2, y+th/2, w-th, h-th, Math.max(0,r-th/2));
  ctx.clip('evenodd');

  let phase=0;
  if (r>0.1){
    phase = drawRopeEdge(ctx,tile, x+r,   y,     x+w-r, y,     phase);
    phase = drawRopeArc (ctx,tile, x+w-r, y+r,   r, -Math.PI/2, 0,          phase);
    phase = drawRopeEdge(ctx,tile, x+w,   y+r,   x+w,   y+h-r,  phase);
    phase = drawRopeArc (ctx,tile, x+w-r, y+h-r, r, 0,          Math.PI/2,  phase);
    phase = drawRopeEdge(ctx,tile, x+w-r, y+h,   x+r,   y+h,    phase);
    phase = drawRopeArc (ctx,tile, x+r,   y+h-r, r, Math.PI/2,  Math.PI,    phase);
    phase = drawRopeEdge(ctx,tile, x,     y+h-r, x,     y+r,    phase);
    phase = drawRopeArc (ctx,tile, x+r,   y+r,   r, Math.PI,    3*Math.PI/2,phase);
  }else{
    phase = drawRopeEdge(ctx,tile, x, y, x+w, y, phase);
    phase = drawRopeEdge(ctx,tile, x+w, y, x+w, y+h, phase);
    phase = drawRopeEdge(ctx,tile, x+w, y+h, x, y+h, phase);
    phase = drawRopeEdge(ctx,tile, x, y+h, x, y, phase);
  }
  ctx.restore();

  ctx.save();
  ctx.strokeStyle='#000';
  ctx.lineWidth=Math.max(1.4, th*0.08);
  ctx.beginPath(); ctx.roundRect(x-th/2, y-th/2, w+th, h+th, r+th/2); ctx.stroke();
  ctx.beginPath(); ctx.roundRect(x+th/2, y+th/2, w-th, h-th, Math.max(0,r-th/2)); ctx.stroke();
  ctx.restore();
}

/* -------- å¹¾ä½•ãƒ‘ãƒãƒ«ï¼ˆå¤ªã•è¾¼ã¿ã§ç¢ºå®Ÿã«åã¾ã‚‹ç‰ˆï¼‰ -------- */
const ğ‘='ğ‘', ğ‘¥='ğ‘¥';
function drawGeom(){
  const ctx = fitCanvas(cvsGeom);
  const W = cvsGeom.clientWidth, H = cvsGeom.clientHeight;
  ctx.clearRect(0,0,W,H);
  ctx.font = `${GEO_FONT_PX}px system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif`;

  const margin = 40;
  const aw = Math.max(1, W - 2*margin);
  const ah = Math.max(1, H - 2*margin);

  /* å…ˆã«ãƒ­ãƒ¼ãƒ—ã®å¤ªã•ã‚’æ±ºã‚ã‚‹ï¼ˆå¾“æ¥ã‚ˆã‚Šå°‘ã—ç´°ã‚ï¼‰ */
  const baseLen   = Math.min(W, H);
  const thickness = Math.max(10, Math.min(36, Math.round(baseLen * 0.016)));

  /* å¤ªã•è¾¼ã¿ã§åã¾ã‚‹å¯ç”¨é ˜åŸŸï¼ˆå¤–æ ãŒ Â±th/2 ã¯ã¿å‡ºã‚‹ãŸã‚ï¼‰ */
  const usableW = Math.max(1, aw - thickness);
  const usableH = Math.max(1, ah - thickness);

  /* å˜ä½é•·ï¼šstate.a ãŒ usableW/usableH ã«åã¾ã‚‹ã‚ˆã†ã« */
  const unit = Math.max(0.0001, Math.min(usableW/state.a, usableH/state.a));

  const h = state.x * unit;
  const w = (state.a - state.x) * unit;

  /* å¤–å´ã®ãƒ­ãƒ¼ãƒ—çŸ©å½¢ï¼ˆw+th, h+thï¼‰ãŒä¸­å¤®ã«æ¥ã‚‹ã‚ˆã†åŸç‚¹èª¿æ•´ */
  const ox = margin + (aw - (w + thickness))/2 + thickness/2;
  const oy = H - margin - thickness/2;

  /* ãƒ­ãƒ¼ãƒ—æ  */
  drawRopeRect(ctx, ox, oy - h, w, h, thickness);

  /* å¯¸æ³•ç·šãƒ»ãƒ©ãƒ™ãƒ« */
  ctx.save();
  ctx.strokeStyle='#666'; ctx.fillStyle='#333'; ctx.lineWidth=1.6;
  const tx = Math.round(ox + w + 28);
  ctx.beginPath(); ctx.moveTo(tx, oy-h); ctx.lineTo(tx, oy);
  ctx.moveTo(tx-8, oy-h); ctx.lineTo(tx+8, oy-h);
  ctx.moveTo(tx-8, oy);   ctx.lineTo(tx+8, oy); ctx.stroke();
  ctx.fillText(`ç¸¦ã®é•·ã• = ${ğ‘¥} = ${state.x.toFixed(3)}`, tx+10, oy - h/2);

  const ty = Math.round(oy + 30);
  ctx.beginPath(); ctx.moveTo(ox, ty); ctx.lineTo(ox+w, ty);
  ctx.moveTo(ox, ty-8); ctx.lineTo(ox, ty+8);
  ctx.moveTo(ox+w, ty-8); ctx.lineTo(ox+w, ty+8); ctx.stroke();
  const wLabel = `æ¨ªã®é•·ã• = ${ğ‘} âˆ’ ${ğ‘¥} = ${(state.a-state.x).toFixed(3)}`;
  ctx.fillText(wLabel, ox + w/2 - ctx.measureText(wLabel).width/2, ty + GEO_FONT_PX*0.9);
  ctx.restore();

  /* æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ï¼ˆãƒ•ã‚©ãƒ³ãƒˆ2å€ï¼‰ */
  ctx.save();
  const yVal = state.x*(state.a-state.x);
  const lines = [
    `ãƒ­ãƒ¼ãƒ—ã®é•·ã•ï¼š${(2*state.a).toFixed(3)}`,
    `ç¸¦ã®é•·ã•ï¼š${ğ‘¥} = ${state.x.toFixed(3)}`,
    `æ¨ªã®é•·ã•ï¼š${ğ‘} âˆ’ ${ğ‘¥} = ${(state.a-state.x).toFixed(3)}`,
    `é¢ç© = ${yVal.toFixed(3)}`
  ];
  const pad = 12, bx=18, by=18;
  const maxw = Math.max(...lines.map(s=>ctx.measureText(s).width));
  const boxW = maxw + pad*2;
  const boxH = GEO_LINE_H*lines.length + pad*2;

  ctx.fillStyle='#fff8d2'; ctx.strokeStyle='#b28a20'; ctx.lineWidth=1.6;
  ctx.beginPath(); ctx.roundRect(bx, by, boxW, boxH, 12); ctx.fill(); ctx.stroke();
  ctx.fillStyle='#333';
  lines.forEach((s,i)=> ctx.fillText(s, bx+pad, by+pad + GEO_LINE_H*(i+0.75)));
  ctx.restore();
}

/* -------- ç›®ç››ã‚Šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ & é–¢æ•°ãƒ‘ãƒãƒ« -------- */
function niceTicks(min, max, maxCount=8){
  const span = max-min; if (span<=0 || !isFinite(span)) return {start:min, step:1, count:2};
  const stepRaw = span / Math.max(1, maxCount);
  const pow10 = Math.pow(10, Math.floor(Math.log10(stepRaw)));
  const bases = [1,2,2.5,5,10];
  let step=bases[0]*pow10;
  for(const b of bases){ const s=b*pow10; if (span/s<=maxCount){ step=s; break; } }
  const start = Math.ceil(min/step)*step;
  const count = Math.floor((max-start)/step)+1;
  return {start, step, count:Math.max(2,count)};
}
function drawGraph(){
  const ctx = fitCanvas(cvsGraph);
  const W = cvsGraph.clientWidth, H = cvsGraph.clientHeight;
  ctx.clearRect(0,0,W,H);
  ctx.font = '12px system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif';

  /* ä½™ç™½ã‚’å°‘ã—åºƒã’ã¦ã€ç›®ç››ãŒæ¶ˆãˆãªã„ã‚ˆã†ã« */
  const marginL=88, marginR=20, marginT=28, marginB=56;
  const plotW=Math.max(1, W-marginL-marginR), plotH=Math.max(1, H-marginT-marginB);

  const xMin=0, xMax=Math.max(1e-6,state.a);
  const yMin=0, yMax=Math.max(1e-6, state.a*state.a/4);

  const X = v=> marginL + (v-xMin)/(xMax-xMin)*plotW;
  const Y = v=> marginT + (1-(v-yMin)/(yMax-yMin))*plotH;

  ctx.fillStyle='#f7f7f7'; ctx.fillRect(marginL,marginT,plotW,plotH);
  ctx.strokeStyle='#e5e5e5'; ctx.lineWidth=1;

  const tx = niceTicks(xMin, xMax, 8);
  const ty = niceTicks(yMin, yMax, 8);

  for(let i=0;i<tx.count;i++){
    const xv=tx.start+tx.step*i, sx=X(xv);
    ctx.beginPath(); ctx.moveTo(sx,marginT); ctx.lineTo(sx,marginT+plotH); ctx.stroke();
    const s=(tx.step<1)?xv.toFixed(1):xv.toFixed(0), w=ctx.measureText(s).width;
    ctx.fillStyle='#555'; ctx.fillText(s, sx-w/2, marginT+plotH+16);
  }
  for(let j=0;j<ty.count;j++){
    const yv=ty.start+ty.step*j, sy=Y(yv);
    ctx.beginPath(); ctx.moveTo(marginL,sy); ctx.lineTo(marginL+plotW,sy); ctx.stroke();
    const s=(ty.step<1)?yv.toFixed(1):yv.toFixed(0), w=ctx.measureText(s).width;
    ctx.fillStyle='#555'; ctx.fillText(s, marginL-w-8, sy+4);
  }

  ctx.strokeStyle='#666'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(marginL,marginT+plotH); ctx.lineTo(marginL+plotW,marginT+plotH); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(marginL,marginT); ctx.lineTo(marginL,marginT+plotH); ctx.stroke();

  if (state.showTrace && state.trace.length>=2){
    ctx.strokeStyle='#1f77b4'; ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(X(state.trace[0][0]), Y(state.trace[0][1]));
    for(let i=1;i<state.trace.length;i++) ctx.lineTo(X(state.trace[i][0]), Y(state.trace[i][1]));
    ctx.stroke();
  }

  const px=state.x, py=state.x*(state.a-state.x);
  ctx.fillStyle='#d62728';
  ctx.beginPath(); ctx.arc(X(px),Y(py),5,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='#fff'; ctx.lineWidth=1.2; ctx.stroke();

  const label=`(${px.toFixed(2)}, ${py.toFixed(2)})`;
  const tw = ctx.measureText(label).width;
  const txp = X(px)+10, typ = Y(py)-10;
  ctx.fillStyle='rgba(255,255,255,.92)'; ctx.strokeStyle='#666';
  ctx.beginPath(); ctx.roundRect(txp-6,typ-16,tw+12,22,8); ctx.fill(); ctx.stroke();
  ctx.fillStyle='#333'; ctx.fillText(label, txp, typ);

  ctx.fillStyle='#333';
  ctx.fillText('é¢ç©', marginL-32, marginT-6);
  ctx.fillText('ç¸¦ã®é•·ã•', marginL+plotW+6, marginT+plotH+16);
}

/* -------- åˆæœŸåŒ– -------- */
(function init(){
  document.getElementById('labA').textContent='ğ‘:'; document.getElementById('labX').textContent='ğ‘¥:';
  xIn.max=state.a; aIn.value=state.a; xIn.value=state.x; xRange.value=Math.round((state.x/state.a)*1000);
  drawAll();
  window.addEventListener('resize', drawAll, {passive:true});
  window.addEventListener('orientationchange', drawAll, {passive:true});
})();
function drawAll(){ drawGeom(); drawGraph(); }
</script>
</body>
</html>
